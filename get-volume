#!/usr/bin/env bash
set -euo pipefail

# Prefer PipeWire (wpctl)
if command -v wpctl >/dev/null 2>&1; then
  out="$(wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null || true)"
  # Examples:
  # "Volume: 0.35"
  # "Volume: 0.35 [MUTED]"
  if [[ -n "${out}" ]]; then
    vol="$(awk '{print $2}' <<<"${out}" | sed 's/[^0-9.]*//g')"
    muted="$(grep -qi muted <<<"${out}" && echo yes || echo no)"
    if [[ -n "${vol}" ]]; then
      pct="$(python3 - <<PY
v=float("${vol}")
print(int(round(v*100)))
PY
)"
      if [[ "${muted}" == "yes" ]]; then
        echo "MUT"
      else
        echo "${pct}%"
      fi
      exit 0
    fi
  fi
fi

# PulseAudio fallback (pactl)
if command -v pactl >/dev/null 2>&1; then
  sink="$(pactl get-default-sink 2>/dev/null || true)"
  if [[ -n "${sink}" ]]; then
    muted="$(pactl get-sink-mute "${sink}" 2>/dev/null | awk '{print $2}' || true)"
    volline="$(pactl get-sink-volume "${sink}" 2>/dev/null | head -n1 || true)"
    pct="$(grep -oE '[0-9]+%' <<<"${volline}" | head -n1 | tr -d '%' || true)"
    if [[ "${muted}" == "yes" ]]; then
      echo "MUT"
      exit 0
    fi
    if [[ -n "${pct}" ]]; then
      echo "${pct}%"
      exit 0
    fi
  fi
fi

# ALSA fallback (no pulse device)
if command -v amixer >/dev/null 2>&1; then
  out="$(amixer -D default get Master 2>/dev/null || true)"
  pct="$(grep -oE '[0-9]+%' <<<"${out}" | tail -n1 | tr -d '%' || true)"
  mute="$(grep -oE '\[(on|off)\]' <<<"${out}" | tail -n1 | tr -d '[]' || true)"
  if [[ "${mute}" == "off" ]]; then
    echo "MUT"
    exit 0
  fi
  if [[ -n "${pct}" ]]; then
    echo "${pct}%"
    exit 0
  fi
fi

echo "-"
exit 0
